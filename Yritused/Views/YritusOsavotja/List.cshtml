
@model YritusOsavotjadListViewModel

@{
    ViewBag.Title = "Üritustest osavõtjad";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<script>
    var yritusOsavotjaId = "";
    var deleteUrl = '@Url.Action("DeleteYritusOsavotja", "YritusOsavotja")';
    var orderBy = '@Model.OrderBy';
    var pageNr = '@(Model.PagingInfo == null ? 1 : Model.PagingInfo.PageNo)';
</script>

<script src="/lib/contextmenu/context.js"></script>
<script src="/lib/contextmenu/filter.js"></script>
<link rel="stylesheet" href="/lib/yritus/css/yritusosavotjad.css" />
<script src="/lib/yritus/src/yritusosavotjadlist.js"></script>

<div class="table-responsive bgcolor">
    <table class="table table-sm table-hover table-condensed">
        <thead class="thead-light">
            <tr>
                <th class="th-align-right"><a href='@OrderHref("Id")'><span id="spId" class="alink">Number</span></a></th>
                <th class="th-align-left"><a href='@OrderHref("YrituseNimi")'><span id="spYrituseNimi" class="alink">Ürituse nimi</span></a></th>
                <th class="th-align-right"><a href='@OrderHref("YrituseAeg")'><span id="spYrituseAeg" class="alink">Ürituse aeg</span></a></th>
                <th class="th-align-left"><a href='@OrderHref("YrituseKoht")'><span id="spYrituseKoht" class="alink">Ürituse koht</span></a></th>
                <th class="th-align-left"><a href='@OrderHref("Osavotja")'><span id="spOsavotja" class="alink">Osavõtja</span></a></th>
                <th class="th-align-left"><a href='@OrderHref("Isikukood")'><span id="spIsikukood" class="alink">Isikukood</span></a></th>
                <th class="th-align-right"><a href='@OrderHref("Loodud")'><span id="spLoodud" class="alink">Loodud</span></a></th>
                <th class="th-align-right"><a href='@OrderHref("Muudetud")'><span id="spMuudetud" class="alink">Muudetud</span></a></th>
                <th class="th-align-center">Toimingud</th>
            </tr>
        </thead>
        <tbody>
            @foreach (YritusOsavotja yo in Model.YritusOsavotjad ?? new List<YritusOsavotja>())
            {
                <tr>
                    @{
                        var yritus = GetYritus(yo.Yritus_Id);
                        var osavotja = GetOsavotja(yo.Osavotja_Id);
                        var yrituseaeg = @CreatedDateTime(yritus.YrituseAeg);

                        var loodud = CreatedDateTime(yo.Loodud);
                        var muudetud = yo.Muudetud == null ? string.Empty : CreatedDateTime((DateTime)yo.Muudetud);

                        var displayClass = "";
                    }
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-Id" : "input-Id-deprecated";
                    }
                    <filtercell class="yritusosavotja-right-justified @displayClass" name="Id" id="@yo.Id" value="@yo.Id" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-YrituseNimi" : "input-YrituseNimi-deprecated";
                    }
                    <filtercell class="yritusosavotja-left-justified @displayClass" name="YrituseNimi" id="@yo.Id" value="@yritus.YrituseNimi" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-YrituseAeg" : "input-YrituseAeg-deprecated";
                    }
                    <filtercell class="yritusosavotja-right-justified @displayClass" name="YrituseAeg" id="@yo.Id" value="@yrituseaeg" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-YrituseKoht" : "input-YrituseKoht-deprecated";
                    }
                    <filtercell class="yritusosavotja-left-justified @displayClass" name="YrituseKoht" id="@yo.Id" value="@yritus.YrituseKoht" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-OsavotjaTaisnimi" : "input-OsavotjaTaisnimi-deprecated";
                    }
                    <filtercell class="yritusosavotja-left-justified @displayClass" name="OsavotjaTaisnimi" id="@yo.Id" value="@osavotja.Taisnimi" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-OsavotjaIsikukood" : "input-OsavotjaIsikukood-deprecated";
                    }
                    <filtercell class="yritusosavotja-left-justified @displayClass" name="OsavotjaIsikukood" id="@yo.Id" value="@osavotja.Isikukood" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-Loodud" : "input-Loodud-deprecated";
                    }
                    <filtercell class="yritusosavotja-right-justified @displayClass" name="Loodud" id="@yo.Id" value="@loodud" />
                    @{
                        displayClass = yritus.YrituseAeg > DateTime.Now ? "input-Muudetud" : "input-Muudetud-deprecated";
                    }
                    <filtercell class="yritusosavotja-right-justified @displayClass" name="Muudetud" id="@yo.Id" value="@muudetud" />
                    <td class="yritusosavotja-center-justified">
                        @{
                            if (yritus.YrituseAeg > DateTime.Now) {
                                var tooltipTitle = string.Format("Kustutada üritusest osavõtja {0}", yo.Id);
                                <a href="#">
                                    <i class="fas fa-trash" style="font-size: 1.25em; color: #140c30;" onclick="kustutaYritusOsavotja('@yo.Id')"
                                       data-toggle="tooltip" data-placement="left" data-type="info" title="@tooltipTitle"></i>
                                </a>
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <input type="hidden" id="model_orderby" value="@Model.OrderBy" />
    <input type="hidden" id="model_pageno" value="@(Model.PagingInfo == null ? 1 : Model.PagingInfo.PageNo)" />
    <input type="hidden" id="model_pagesize" value="@(Model.PagingInfo == null ? 5 : Model.PagingInfo.PageSize)" />
    <input type="hidden" id="model_filterfield" value="@Model.FilterField" />
    <input type="hidden" id="model_filtervalue" value="@Model.FilterValue" />
</div>

<paging total-records="@(Model.PagingInfo == null ? 1 : Model.PagingInfo.TotalRecords)"
    page-no="@(Model.PagingInfo == null ? 1 :Model.PagingInfo.PageNo)"
    page-size="@(Model.PagingInfo == null ? 1 : Model.PagingInfo.PageSize)"
    query-string-value="@("orderby=" + Model.OrderBy + "&" + "filterfield=" + Model.FilterField + "&" + "filterValue=" + Model.FilterValue)">
</paging>

@functions {
    private string? OrderHref(string field) => @Url.Action("List", "Yritus",
    new
    {
        orderby = field,
        orderbybefore = Model.OrderBy,
        p = Model.PagingInfo == null ? 1 : Model.PagingInfo.PageNo,
        s = Model.PagingInfo == null ? 1 : Model.PagingInfo.PageSize,
        filterField = Model.FilterField,
        filterValue = Model.FilterValue
    });

    public string CreatedDateTime(DateTime date)
    {
        return Beautify(date.Day) + "." + Beautify(date.Month) + "." + date.Year + " " + Beautify(date.Hour) + ":" + Beautify(date.Minute) + ":" + Beautify(date.Second);
    }

    private string Beautify(int partOfDate)
    {
        if (partOfDate < 10)
        {
            return "0" + partOfDate.ToString();
        }
        else
        {
            return partOfDate.ToString();
        }
    }

    private Yritus GetYritus(int Id)
    {
        IEnumerable<Yritus> yritused = Model.Yritused ?? new List<Yritus>();

        return yritused.Where(y => y.Id == Id).SingleOrDefault() ?? new Yritus();
    }

    private Osavotja GetOsavotja(int Id)
    {
        IEnumerable<Osavotja> osavotjad = Model.Osavotjad ?? new List<Osavotja>();

        return osavotjad.Where(o => o.Id == Id).SingleOrDefault() ?? new Osavotja();
    }
}
